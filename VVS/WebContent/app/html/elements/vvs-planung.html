<polymer-element name="vvs-planung">
	<template>
		<link rel="stylesheet" type="text/css" href="../../css/elements.css" shim-shadowdom>
		<core-media-query query="max-width: 1400px" queryMatches="{{smallScreen}}"></core-media-query>
		<paper-shadow z="3" class="shadow">
			<div vertical layout>
				<!-- Name der Vorlesung und Progress-Balken -->
				<div horizontal layout>
					<span class="headline vertical-input">{{vorlesung.fachInstanz.fach.name}}</span>
					<paper-progress class="headline vertical-input progress" value="{{progressProzent}}"></paper-progress>
					<span class="headline vertical-input">{{progress}} / {{vorlesung.fachInstanz.stunden}}</span>
				</div>
				<!-- Hauptscreen -->
				<div horizontal?="{{!smallScreen}}" vertical?="{{smallScreen}}" layout class="horizontal-input vertical-input">
					<div auto-vertical?="{{smallScreen}}" vertical layout flex?="{{!smallScreen}}" one?="{{!smallScreen}}" class="vertical-input">
						<paper-shadow z="2" class="inner-shadow">
							<div horizontal layout>
								<span horizontal layout center-center class="small-headline" flex>Datum</span>
								<span horizontal layout center-center class="small-headline" flex>Von</span>
								<span horizontal layout center-center class="small-headline" flex>Bis</span>
								<span horizontal layout center-center class="small-headline" flex>Dauer</span>
								<span horizontal layout center-center class="small-headline" flex>Pause</span>
								<span horizontal layout center-center class="small-headline" flex>Raum</span>
								<paper-icon-button class="hide"></paper-icon-button>
								<paper-icon-button class="hide"></paper-icon-button>
							</div>
							<template repeat="{{item in vorlesungstermine}}">
								<paper-shadow z="1" class="{{item.id === vorlesungstermin.id ? 'inner-inner-shadow highlight' : 'inner-inner-shadow'}}">
									<div horizontal layout center>
										<span horizontal layout center-center flex>{{item.datum}}<paper-icon-button icon="assignment" hidden?="{{!item.klausur}}"></paper-icon-button></span>
										<span horizontal layout center-center flex>{{item.startUhrzeit}}</span>
										<span horizontal layout center-center flex>{{item.endUhrzeit}}</span>
										<span horizontal layout center-center flex>{{item.dauer}}</span>
										<span horizontal layout center-center flex>{{item.pause}}</span>
										<span horizontal layout center-center flex>{{item.raum}}</span>
										<paper-icon-button on-click="{{edit}}" icon="create" disabled?="{{disableToggle}}" self-center></paper-icon-button>
										<paper-icon-button on-click="{{initDoDelete}}" icon="delete" disabled?="{{disableToggle}}" self-center></paper-icon-button>
									</div>
								</paper-shadow>
							</template>
						</paper-shadow>
						<div horizontal layout center class="horizontal-button-bar horizontal-input horizontal-verticalizable">
							<paper-button on-click={{update} raised disabled?="{{disableToggle}}">Speichern</paper-button>
							<paper-button on-click={{initDeleteVorlesung}} raised disabled?="{{disableToggle}}">L&ouml;schen</paper-button>
							<paper-button on-click={{cancel}} raised disabled?="{{disableToggle}}">Abbrechen</paper-button>				
							<paper-spinner active?={{disableToggle}} self-center></paper-spinner>
						</div>
					</div>
					<div auto-vertical?="{{smallScreen}}" flex?="{{!smallScreen}}" class="vertical-input">
						<div horizontal layout class="horizontal-input" flex>
							<div vertical layout class="vertical-input" flex>
								<div horizontal start layout class="horizontal-input">
									<polymer-date-picker id="datePicker" relatedTarget="{{$.datum}}" halign="left" style="z-index:99" selectedDate="{{selectedDate}}" opened="false"></polymer-date-picker>
									<paper-input-decorator id="datum" label="Datum"  on-click="{{toggleDatePicker}}" error="Pflichtfeld: ung&uuml;ltiges Datum" autoValidate isInvalid="{{invalid.datum}}" floatingLabel flex>
										<input is="core-input" pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}" preventInvalidInput="true" value="{{vorlesungstermin.datum}}">
									</paper-input-decorator>						
								</div>
								<div horizontal start layout class="horizontal-input">
									<paper-input-decorator id="startUhrzeit" label="Uhrzeit von" error="Pflichtfeld: ung&uuml;ltige Uhrzeit" autoValidate isInvalid="{{invalid.startUhrzeit}}" floatingLabel flex>
										<input is="core-input" type="text" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}" value={{vorlesungstermin.startUhrzeit}} maxlength="100" disabled?="{{disableToggle}}">
									</paper-input-decorator>		
									<paper-input-decorator id="endUhrzeit" label="Uhrzeit bis" error="Pflichtfeld: ung&uuml;ltige Uhrzeit" autoValidate isInvalid="{{invalid.endUhrzeit}}" floatingLabel flex>
										<input is="core-input" type="text" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}" value={{vorlesungstermin.endUhrzeit}} maxlength="100" disabled?="{{disableToggle}}">
									</paper-input-decorator>			
								</div>
								<div horizontal start layout class="horizontal-input">
									<paper-input-decorator id="pause" label="Pause" error="Ung&uuml;tige Pause" autoValidate isInvalid="{{invalid.pause}}" floatingLabel flex>
										<input is="core-input" type="text" pattern="[0-9]+" value={{vorlesungstermin.pause}} maxlength="100" disabled?="{{disableToggle}}">
									</paper-input-decorator>	
									<paper-input-decorator id="raum" label="Raum" error="Ung&uuml;ltiger Raum" autoValidate isInvalid="{{invalid.raum}}" floatingLabel flex>
										<input is="core-input" type="text" pattern="[0-9]{3}[A-Z]" value={{vorlesungstermin.raum}} maxlength="100" disabled?="{{disableToggle}}">
									</paper-input-decorator>
								</div>
								<div horizontal start layout class="horizontal-input">
									<span>Klausur</span>
									<paper-checkbox checked="{{vorlesungstermin.klausur}}" self-center disabled?="{{toggleDisabled}}"></paper-checkbox>
								</div>
								<div horizontal start layout class="horizontal-button-bar horizontal-input">
									<paper-button on-click={{add}} raised disabled?="{{disableToggle}}" flex>&Uuml;bernehmen</paper-button>
									<paper-button on-click={{reject}} raised disabled?="{{disableToggle}}" flex>Verwerfen</paper-button>
								</div>
							</div>
							<div vertical layout class="vertical-input" flex>
								<!-- TODO: Hier kommt die Kalender-Übersicht -->
								<div horizontal start layout class="horizontal-input">
									<paper-input-decorator id="mname" label="Platzhalter Kalender" error="Pflichtfeld" floatingLabel autoValidate isInvalid="{{invalid.mname}}" flex>
										<input is="core-input" type="text" value="{{inputModulInstanz.modul.name}}" maxlength="100" disabled?="{{disableToggle || selectedModul >= 0}}" required>
									</paper-input-decorator>
								</div>
								<!-- Kalender-Übersicht Ende -->
							</div>
						</div>
					</div>
				</div>
				<br/><br/>
				<!-- Dozentensuche -->
				<div horizontal layout>
					<core-field style="border: 1px solid #FF0000; margin-left: 30px; height: 40px; width: 400px;">
						<input placeholder="Dozentensuche" flex>
					</core-field>
					<paper-button on-click={{search}} style="height: 42px; margin-left: 0px;"><core-icon icon="search"></core-icon></paper-button>
				</div>
				<div horizontal layout class="horizontal-input ">	
					<span class="headline" style="margin-top: 20px;">Ausgew&auml;hlter Dozent: {{Dozent}}</span>
				</div>
				<br/><br/>
				<div horizontal layout class="horizontal-input">
					<div vertical layout flex>
						<paper-shadow z="2" class="inner-shadow">
							<div horizontal layout>
								<span horizontal layout center-center class="small-headline" flex>Vergangene Dozenten</span>
								<paper-icon-button class="hide"></paper-icon-button>
							</div>
							<template repeat="{{item in vergangeneDozenten}}">
								<paper-shadow z="1" class="inner-inner-shadow">
									<div horizontal layout center>
										<span horizontal layout center-center flex>{{item.name}}, {{item.vorname}}</span>
										<paper-checkbox self-center disabled?="{{toggleDisabled}}"></paper-checkbox>
									</div>
								</paper-shadow>
							</template>
						</paper-shadow>
					</div>
					<div vertical layout flex>
						<paper-shadow z="2" class="inner-shadow">
							<div horizontal layout>
								<span horizontal layout center-center class="small-headline" flex>Alle Dozenten</span>
								<paper-icon-button class="hide"></paper-icon-button>
							</div>
							<template repeat="{{item in dozenten}}">
								<paper-shadow z="1" class="inner-inner-shadow">
									<div horizontal layout center>
										<span horizontal layout center-center flex>{{item.name}}, {{item.vorname}}</span>
										<paper-checkbox self-center disabled?="{{toggleDisabled}}"></paper-checkbox>
									</div>
								</paper-shadow>
							</template>
						</paper-shadow>
					</div>
				</div>
			</div>
		</paper-shadow>
		<paper-action-dialog id="delete_vorlesungstermin_dialog" heading="Die Vorlesung am {{vorlesungsterminToDelete.datum}} wirklich l&ouml;schen?">
			<paper-button affirmative>Nein</paper-button>
			<paper-button on-click="{{doDelete}}" affirmative autofocus>L&ouml;schen</paper-button>
		</paper-action-dialog>
		<paper-action-dialog id="delete_vorlesung_dialog" heading="Die Vorlesung {{vorlesung.fachInstanz.fach.name}} wirklich l&ouml;schen?">
			<paper-button affirmative>Nein</paper-button>
			<paper-button on-click="{{deleteVorlesung}}" affirmative autofocus>L&ouml;schen</paper-button>
		</paper-action-dialog>
	</template>
	<script type="text/javascript">
	"use strict";
	Polymer('vvs-planung',
	{
		vorlesung: new model.templates.Vorlesung(),
		vorlesungstermin: new model.templates.Termin(),
		vorlesungstermine: [],
		vorlesungsterminToDelete: null,
		vergangeneDozenten: [],
		dozenten: [],
		deletedVorlesungstermine: [],
		raum: null,
		progress: 0,
		progressProzent: 0,
		nextVorlesungsterminID: -1,
		selectedDate: '2000-01-01',
		datePickerOpened: false,
		disableToggle: true,
		invalid : {},
		//Publish those attributes to home
		publish: {
			pageParameter: {},
			pageLoaded: {},
			toasts: {}
		},
		//Initialize the screen
		ready : function() {
			var self = this;
			self.vorlesung = new model.templates.Vorlesung();
			self.vorlesungstermin = new model.templates.Termin();
			self.vorlesungstermine = [];
			self.vorlesungsterminToDelete = null;
			self.vergangeneDozenten = [];
			self.dozenten = [];
			self.deletedVorlesungstermine = [];
			self.raum = null;
			self.progress = 0;
			self.progressProzent = 0;
			self.nextVorlesungsterminID = -1;
			self.selectedDate = self.today();
			self.datePickerOpened = false;
			self.disableToggle = true;
			self.invalid = {};
			var showVorlesung = new model.templates.Vorlesung();
			showVorlesung.id = 1;
			//TODO showVorlesung.id = self.pageParameter.vorlesung.id;
			//Load selected Vorlesung
			//TODO Deeprun erforderlich???????????????????????????????????????????????????????????????????????????
			model.webService.getVorlesung(showVorlesung, function(api) {
				if (!api.isError)
				{
					self.vorlesung = api.response;
					//Load available Vorlesungstermine
					model.webService.getAllVorlesungTermine(self.vorlesung, function(api) {
						if (!api.isError)
						{
							self.vorlesungstermine = api.response;
							//TODO dauer berechnen
							var i;
							for (i = 0; i < self.vorlesungstermine.length; i++)
							{
								self.vorlesungstermine[i].dauer = self.calculateDauer(self.vorlesungstermine[i].startUhrzeit, self.vorlesungstermine[i].endUhrzeit, self.vorlesungstermine[i].pause);
							}
							self.calculateProgress();
						}
						else
						{
							console.log(JSON.stringify(api));
							self.toasts.error.show();
						}
					});
					//Load default Kursraum
					var kurs = new model.templates.Kurs();
					kurs.id = self.vorlesung.kursID;
					model.webService.getAllKursBlocklagen(kurs, function(api) {
						if (!api.isError)
						{
							var i;
							for (i = 0; i < api.response.length; i++)
							{
								if (api.response[i].semester === self.vorlesung.semester)
								{
									self.raum = api.response[i].raum;
									self.vorlesungstermin.raum = self.raum;
									break;
								}
							}
						}
						else
						{
							console.log(JSON.stringify(api));
							self.toasts.error.show();
						}
					});
					//Load vergangene Dozenten
					model.webService.getVorlesungDozenten(self.vorlesung, function(api) {
						if (!api.isError)
						{
							self.vergangeneDozenten = api.response;
							//Load alle Dozenten
							model.webService.getAllDozenten(function(api) {
								if (!api.isError)
								{
									self.dozenten = api.response;
									var i;
    	    						for (i = 0; i < self.vergangeneDozenten.length; i++)
    	    						{
    	        						var ii;
    	    							for (ii = 0; ii < self.dozenten.length; ii++)
    	    							{
    	    								if (self.vergangeneDozenten[i].id === self.dozenten[ii].id)
    	    								{
    	    									self.dozenten.splice(ii, 1);
    	    									break;
    	    								}
    	    							}
    	    						}
    	    						//Enable inputs
    	    						self.disableToggle = false;
    	    						//Set inputs to invalid
    								self.invalid.datum = true;
    								self.invalid.startUhrzeit = true;
    								self.invalid.endUhrzeit = true;
								}
								else
								{
									console.log(JSON.stringify(api));
									self.toasts.error.show();
								}
							});
							
						}
						else
						{
							console.log(JSON.stringify(api));
							self.toasts.error.show();
						}
					});
				}
				else
				{
					console.log(JSON.stringify(api));
					self.toasts.error.show();
				}
			});
		},
		//Add Vorlesungstermin
		add: function() {
			var self = this;
			if(!this.checkInputs()) {
				return;
			}
			self.vorlesungstermin.dauer = self.calculateDauer(self.vorlesungstermin.startUhrzeit, self.vorlesungstermin.endUhrzeit, self.vorlesungstermin.pause);
			//The Vorlesungstermin is completely new, we need to set an internal ID and add it to the Vorlesung
			if(self.vorlesungstermin.id <= 0)
			{
				self.vorlesungstermin.id = self.nextVorlesungsterminID;
				self.nextVorlesungsterminID--;
				self.vorlesungstermine.push(self.vorlesungstermin);
			}
			//We are referencing a Vorlesungstermin which is already in the Vorlesung
			else
			{ 
				var i;
				for (i = 0; i < self.vorlesungstermin.length; i++)
				{
					if (self.vorlesungstermin.id === self.vorlesungstermine[i].id)
					{
						self.vorlesungstermine[i] = self.vorlesungstermin;
						self.reject();
						break;
					}
				}
			}
			this.calculateProgress();
			this.reject();
	    },
	    //Reject input fields
		reject: function() {
			this.vorlesungstermin = new model.templates.Termin();
			this.vorlesungstermin.raum = this.raum;
		},
		//Edit Vorlesungstermin
		edit: function(e, detail, sender) {
			this.vorlesungstermin = this.vorlesungstermine[this.vorlesungstermine.indexOf(e.target.templateInstance.model.item)];
			this.job('update-labels-edit', function() {
				this.$.datum.inputAction();
				this.$.startUhrzeit.inputAction();
				this.$.endUhrzeit.inputAction();
				this.$.pause.inputAction();
				this.$.raum.inputAction();
			}, 100);
		},
		//Show Action Dialog for Deletion of Vorlesungstermin
		initDoDelete: function(e, detail, sender) {
			this.vorlesungsterminToDelete = e.target.templateInstance.model.item;
			this.$.delete_vorlesungstermin_dialog.toggle();
		},
		//Delete a Vorlesungstermin
		doDelete: function() {
			var self = this;
			var i;
			for (i = 0; i < self.vorlesungstermine.length; i++)
			{
				if (self.vorlesungstermine[i].id === self.vorlesungsterminToDelete.id)
				{
					self.deletedVorlesungstermine.push(self.vorlesungstermine[i]);
					self.vorlesungstermine.splice(i, 1);
					self.calculateProgress();
					break;
				}
			}
			this.reject();
		},
		//Show Action Dialog for Deletion of Vorlesung
		initDeleteVorlesung: function()
		{
			this.$.delete_vorlesung_dialog.toggle();
		},
		//Delete a Vorlesung
		deleteVorlesung: function()
		{
			var self = this;
			//Disable inputs
			self.disableToggle = true;
			model.webService.deleteVorlesung(self.vorlesung, function(api) {
				if(!api.isError)
				{
					self.toasts.success.show();
					self.cancel();
				}
				else
				{
					//Enable inputs
					self.disableToggle = false;
					self.toasts.error.show();	
				}	
			});
		},
		//Update Vorlesung with all Vorlesungstermine
		update: function() {
			var self = this;
			//delete Vorlesungstermine aus deletedVorlesungstermine
    		var self = this;
    		//Disable inputs
    		self.disableToggle = true;
    		//Update Vorlesung
    		model.webService.updateVorlesung(self.vorlesung, function(api) {
    			if (!api.isError)
				{
					var i;
					var deepRuns = 0;
					//Delete all deleted Vorlesungstermine
					for (i = 0; i < self.deletedVorlesungstermine.length; i++)
					{
						model.webService.deleteVorlesungTermin(self.vorlesung, self.deletedVorlesungstermine[i], function(api) {
							if(!api.isError) {
								deepRuns++;
								//After last deletion move to adding the added Vorlesungstermine
								if(deepRuns === self.deletedVorlesungstermine.length) {
									self.deletedFaecher = [];
									var veryDeepRuns = 0;
									//Add Vorlesungstermine
									for (i = 0; i < self.vorlesungstermine.length; i++)
									{
										//Create new Vorlesungstermine
										if (self.vorlesungstermine[i].id <= 0)
										{
											model.webService.createVorlesungTermin(self.vorlesung, self.vorlesungstermine[i], function(api) {
												if(!api.isError)
												{
													veryDeepRuns++;
												}
												else
												{
													console.log(JSON.stringify(api));
													self.toasts.error.show();
												}
											});
										}
										//Update existing Vorlesungstermine
										else
										{
											model.webService.updateVorlesungTermin(self.vorlesung, self.vorlesungstermine[i], function(api) {
												if(!api.isError)
												{
													veryDeepRuns++;													
												}
												else
												{
													console.log(JSON.stringify(api));
													self.toasts.error.show();
												}
											});
										}
										//Enable inputs after last webservice call
										if (veryDeepRuns === self.dozentenFaecher.length) {
											self.disableToggle = false;
											self.toasts.success.show();
										}
									}
									//Enable inputs after last webservice call
									if(veryDeepRuns === 0 && self.dozentenFaecher.length === 0) {
										self.disableToggle = false;
										self.toasts.success.show();
									}
								}
							} else {
								console.log(JSON.stringify(api));
								self.toasts.error.show();
							}
						});
					}
					//Also add new Vorlesungstermine when no Vorlesungstermin was deleted
					if(deepRuns === 0 && self.deletedVorlesungstermine.length === 0) {
						for (i = 0; i < self.dozentenFaecher.length; i++)
						{
							//Create new Vorlesungstermine
							if (self.vorlesungstermine[i].id <= 0)
							{
								model.webService.createVorlesungTermin(self.vorlesung, self.vorlesungstermine[i], function(api) {
									if(!api.isError)
									{
										deepRuns++;
									}
									else
									{
										console.log(JSON.stringify(api));
										self.toasts.error.show();
									}
								});
							}
							//Update existing Vorlesungstermine
							else
							{
								model.webService.updateVorlesungTermin(self.vorlesung, self.vorlesungstermine[i], function(api) {
									if(!api.isError)
									{
										deepRuns++;												
									}
									else
									{
										console.log(JSON.stringify(api));
										self.toasts.error.show();
									}
								});
							}
							//Enable inputs after last webservice call
							if (deepRuns === self.dozentenFaecher.length)
							{
								self.disableToggle = false;
								self.toasts.success.show();
							}
						}
						//Enable inputs after last webservice call
						if(deepRuns === 0 && self.dozentenFaecher.length === 0)
						{
							self.disableToggle = false;
							self.toasts.success.show();
						}
					}

				}
				else
				{
					console.log(JSON.stringify(api));
					self.toasts.error.show();
				}
    		});
		},
		//Navigate backwards and force a reload
    	cancel: function()
    	{
    		this.pageLoaded.planung = false;
    		window.history.back();
    	},
    	//Calculate Progress for progress-bar
    	calculateProgress: function()
    	{
    		var stunden = 0;
    		var dauer = 0;
    		var i;
    		for (i = 0; i < this.vorlesungstermine.length; i++)
    		{
    			dauer = this.calculateDauer(this.vorlesungstermine[i].startUhrzeit, this.vorlesungstermine[i].endUhrzeit, this.vorlesungstermine[i].pause);
    			stunden = stunden + dauer;
    		}
    		this.progress = stunden;
    		this.progressProzent = this.progress / this.vorlesung.fachInstanz.stunden * 100;
    	},
    	//Calculate dauer
    	calculateDauer: function(start, ende, pause)
    	{
    		var dauer = 0;
    		var startStunden = 0;
    		var startMinuten = 0;
    		var endeStunden = 0;
    		var endeMinuten = 0;
    		var stunden;
    		var minuten;
    		startStunden = parseInt(start.substr(0,2));
    		startMinuten = parseInt(start.substr(3,2));
    		endeStunden = parseInt(ende.substr(0,2));
    		endeMinuten = parseInt(ende.substr(3,2));
    		stunden = endeStunden - startStunden;
    		minuten = endeMinuten - startMinuten;
    		dauer = ((stunden * 60) + minuten - pause) / 45;
    		dauer = +(Math.round(dauer + "e+1")  + "e-1");
    		return dauer;
    	},
    	//Calculate pause
    	calculatePause: function(start, ende)
    	{
    		// TODO
    		// ende - start ausrechnen und in minuten umwandeln
    		// <= 90 Minuten keine Pause, Vorlesungsstunde = 45 Minuten
    		// ab 91 Minuten pro 50 Minuten 5 Minuten Pause
    	},
		//Show DatePicker
		toggleDatePicker: function(e, detail, sender) {
			if(this.disableToggle === true) {
				return;
			}
			//Init or set selected date
			if(this.$.datum.input.value) {
				this.selectedDate = this.vorlesung.datum;
			} else {
				
			}	
			//Wait until the date picker potentially auto closed to reopen it
			this.job('open-date-picker', function() {
				this.$.datum.inputAction();
				this.$.datePicker.open();
				this.datePickerOpened = true;
			}, 100);
		},
		//Close date picker
		selectedDateChanged: function() {
			if(!this.datePickerOpened) {
				return;
			}
			//Read date
			this.vorlesungstermin.datum = this.selectedDate;
			//Update UI
			this.$.datePicker.close();
			this.datePickerOpened = false;
			this.job('label-date-picker', function() {
				this.$.datum.inputAction();
			}, 100);
		},
		//Calculate date of today
		today: function() {
		    var date = new Date();
			var year = date.getFullYear();
		    var month = '0' + (date.getMonth() + 1);
		    month = month.slice(-2, (month.length - 2) + 3);
		    var day = '0' + date.getDate();
		    day = day.slice(-2, (day.length - 2) + 3);
		    return year + '-' + month + '-' + day;
		},
		//Check all invalid properties
		checkInputs : function() {
			for ( var property in this.invalid) {
				if (this.invalid.hasOwnProperty(property)) {
					if (this.invalid[property] === true) {
						return false;
					}
				}
			}
			return true;
		}
	});
	</script>
</polymer-element>