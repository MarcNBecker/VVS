<polymer-element name="vvs-vorlesungsauswahl">
	<template>
		<link rel="stylesheet" href="../../css/elements.css" shim-shadowdom>
		<paper-dialog id="vorlesungsauswahl_overlay" style="width: 50%; height:70%" backdrop="true" layered="true" heading="Vorlesungsauswahl f&uuml;r das {{kurs.kursname}} {{semester}}. Semester">
			<div vertical layout>
				<div vertical layout class="vertical-input">
					<div vertical layout>
						<div horizontal start layout class="horizontal-input vertical-input">
							<paper-input-decorator id="vorlesungSuchenInputDecorater" label="Vorlesung suchen" floatingLabel flex>
								<input is="core-input"  type="text" value={{searchTerm}} maxlength="100" on-keyup="{{suchenEingabe}}">
							</paper-input-decorator>
						</div>
					</div>
					<div vertical layout class="vertical-input">
						<span class="headline">Vorlesungen des aktuellen Semesters</span>
						<paper-shadow z="2" class="inner-shadow">
							<div horizontal layout>
								<span horizontal layout center-center class="small-headline" flex>Name</span>
							</div>
							<template repeat="{{item in aktuelleFaecher}}"> 
								<paper-shadow z="1" class="inner-inner-shadow">
									<div horizontal layout center>
										<paper-checkbox id="aktuell" on-click="{{checkboxChecked}}" style="margin: 2px 5px;" ></paper-checkbox>
										<span horizontal layout center-center flex>{{item.fach.name}}</span>
									</div>
								</paper-shadow>
							</template>
						</paper-shadow>
					</div>
					<div vertical layout class="vertical-input">
						<span class="headline">Verbleibende Vorlesungen</span>
						<paper-shadow z="2" class="inner-shadow">
							<div horizontal layout>
								<span horizontal layout center-center class="small-headline" flex>Name</span>
							</div>
							<template repeat="{{item in verbleibendeFaecher}}"> 
								<paper-shadow z="1" class="inner-inner-shadow">
									<div horizontal layout center>
										<paper-checkbox id="verbleibend" on-click="{{checkboxChecked}}" style="margin: 2px 5px;" ></paper-checkbox>
										<span horizontal layout center-center flex>{{item.fach.name}}</span>
									</div>
								</paper-shadow>
							</template>
						</paper-shadow>
					</div>
					<div vertical layout>
						<div horizontal start layout class="horizontal-input">
							<paper-button on-click="{{save}}" disabled?="{{disableToggle}}" self-center raised>speichern</paper-button>
							<paper-button on-click="{{cancel}}" disabled?="{{disableToggle}}" self-center raised>abbrechen</paper-button>
							<paper-spinner active?={{disableToggle}} self-center></paper-spinner>
						</div>
					</div>
				</div>
			</div>
		</paper-dialog>
	</template>
	<script>
		Polymer("vvs-vorlesungsauswahl",{
			aktuelleFaecher:[],
			verbleibendeFaecher:[],
			selectedFaecher:[],
			searchTerm:"",
			checkedFach: new model.templates.FachInstanz(),
			boolSuchenFachIsEmpty: true,
			disableToggle: true,
			//Publish those attributes to home
			publish: {
				kurs: {},
				semester: 0
			},
			//Initialize the screen
			ready: function (){
				var self = this;
				self.aktuelleFaecher = [];
				self.verbleibendeFaecher = [];
				self.selectedFaecher = [];
				self.searchTerm = "";
				self.checkedFach = new model.templates.FachInstanz();
				self.boolSuchenFachIsEmpty = true;
				self.disableToggle = true;
				//TODO später löschen
				self.kurs = new model.templates.Kurs();
				self.kurs.id = 1;
				self.semester = 1;
				//Load offene Vorlesungen
				model.webService.getAllVorlesungenOffen(self.kurs, function(api) {
					if (!api.isError)
					{
						var i;
						for (i = 0; i < api.response.length; i++)
						{
							//All offene Vorlesungen of selected Semester
							if (api.response[i].semester === self.semester)
							{
								self.aktuelleFaecher.push(api.response[i]);
							}
							//All offene Vorlesungen of other semesters
							else
							{
								self.verbleibendeFaecher.push(api.response[i]);
							}
						}
					}
					else
					{
						console.log(JSON.stringify(api));
					}
				});
				//Enable buttons
				self.disableToggle = false;
				//TODO später löschen
				self.toggle();
			},
			//Show paper-action-dialog
			toggle: function() {
				this.$.vorlesungsauswahl_overlay.toggle();
			},
			//Vorlesung selected
			checkboxChecked: function(e, detail, sender) {
				//Vorlesung of List aktuelle Vorlesungen selected or deselected
				if (sender.getAttribute("id") === "aktuell")
				{
					//Selected
					if (!sender.checked)
					{
						this.selectedFaecher.push(this.aktuelleFaecher[this.aktuelleFaecher.indexOf(e.target.templateInstance.model.item)]);
					}
					//Deselected
					else
					{
						var i = 0;
						for (i = 0; i < this.selectedFaecher.length; i++)
						{
							if (this.selectedFaecher[i].id === this.aktuelleFaecher[this.aktuelleFaecher.indexOf(e.target.templateInstance.model.item)].id)
							{
								this.selectedFaecher.splice(1, i);
							}
						}
					}
				}
				//Vorlesung of List verbleibende Vorlesungen selected or deselected
				else if (sender.getAttribute("id") === "verbleibend")
				{
					//Selected
					if (!sender.checked)
					{
						this.selectedFaecher.push(this.verbleibendeFaecher[this.verbleibendeFaecher.indexOf(e.target.templateInstance.model.item)]);
					}
					//Deselected
					else
					{
						var i = 0;
						for (i = 0; i < this.selectedFaecher.length; i++)
						{
							if (this.selectedFaecher[i].id === this.verbleibendeFaecher[this.verbleibendeFaecher.indexOf(e.target.templateInstance.model.item)].id)
							{
								this.selectedFaecher.splice(i, 1);
							}
						}
					}
				}
			},
	
			emptyLists: function(){
				if (this.aktuelleFaecher.length > 0){
					this.aktuelleFaecher.splice(0,this.aktuelleFaecher.length);		
				}
				if(this.verbleibendeFaecher.length > 0){
					this.verbleibendeFaecher.splice(0,this.verbleibendeFaecher.length);
				}
			},
	
			suchenEingabe: function(){
				if(this.searchTerm ==""){
					if(this.boolSuchenFachIsEmpty != true){
						this.emptyLists();
						this.initLists();
						this.boolSuchenFachIsEmpty = true;
					}
				}else{
					this.emptyLists();
					for (i= 0; i<this.selectedAktuelleFaecher.length; i++){
						var searchTermUC = this.searchTerm.toUpperCase();
						var fachnameUC = this.selectedAktuelleFaecher[i].name.toUpperCase();
						if(fachnameUC.match(searchTermUC)){
							this.aktuelleFaecher.splice(0, 0, {
								fach: this.selectedAktuelleFaecher[i],
								checked: false
							});
						}
					}
					for (i= 0; i<this.selectedVerbleibendeFaecher.length; i++){
						var searchTermUC = this.searchTerm.toUpperCase();
						var fachnameUC = this.selectedVerbleibendeFaecher[i].name.toUpperCase();
						if(fachnameUC.match(searchTermUC)){
							this.verbleibendeFaecher.splice(0, 0, {
								fach: this.selectedVerbleibendeFaecher[i],
								checked: false
							});
						}
					}
					this.boolSuchenFachIsEmpty = false;
				}
			},
		});
	</script>
</polymer-element>
